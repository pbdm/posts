# Server配置

## nginx

* 修改`/etc/nginx/sites-available/default`文件，在`serve`的框里面的空行中输入：

```sh
location /update {
    proxy_pass http://127.0.0.1:22222/github;
}
```

* `/etc/init.d/nginx restart`

## webhooker

* 安装 `https://github.com/rvagg/github-webhook-handler`
* `npm install -g github-webhook-handler`
* 使全局的模块可以在当前目录执行

`npm link github-webhook-handler`

* `vi deploy.js`

```javascript
var http = require('http')
var createHandler = require('github-webhook-handler')
var handler = createHandler({ path: '/github', secret: '******' })

function run_cmd(cmd, args, callback) {
  var spawn = require('child_process').spawn;
  var child = spawn(cmd, args);
  var resp = "";

  child.stdout.on('data', function(buffer) { resp += buffer.toString(); });
  child.stdout.on('end', function() { callback (resp) });
}

http.createServer(function (req, res) {
  handler(req, res, function (err) {
    res.statusCode = 404
    res.end('no such location')
  })
}).listen(22222)

handler.on('error', function (err) {
  console.error('Error:', err.message)
})

handler.on('push', function (event) {
  console.log('Received a push event for %s to %s',
    event.payload.repository.name,
    event.payload.ref);
  run_cmd('sh', ['./deploy-dev.sh'], function(text){ console.log(text) });
})
```

* `vi deploy-dev.sh`

```sh
#!/bin/bash
LOG_FILE='/root/tmp'
WEB_PATH='/var/www/html'
cd $WEB_PATH
echo 'pulling'
git clean -f
git pull
echo 'finished'
echo date
echo "$(date "+%Y-%m-%d %H:%M:%S") [$0:$1] $2" >> $LOG_FILE
```

* 长连接

`npm install -g forever` 使`node`命令可以存在
`apt-get install nodejs-legacy`
`forever start deploy.js`
不要忘了开启gzip

> [lovelucy](http://www.lovelucy.info/auto-deploy-website-by-webhooks-of-github-and-gitlab.html)

## shadowsocks

> [wuchong.me](http://wuchong.me/blog/2015/02/02/shadowsocks-install-and-optimize/)

## vpn

> [vpser.net](http://www.vpser.net/manage/linode-vps-pptp-vpn-howto.html)

## docker(2016-08-14)

* `docker pull ubuntu`
* `docker run -itd -p 80:80 ubuntu pbdm`
* `docker attach pbdm`
* `apt-get update`
* `apt-get install nodejs npm nginx git vim curl`
* `git clone https://github.com/pbdm/pbdm.github.com.git`
* `npm install`
* `npm run start`

## web

将 github 上搭建的静态页面迁移到 nodejs 上

使用 pm2 作为 process manager

采用 koa 作为服务端的框架

在 `async`, `await` 进入标准后再使用 koa2

### 坑

* pm2 的 watcher 有的时候不工作, 需要 `pm2 stop name --watch` 再开才可以, 暂不明原因
* pm2 在 docker 里运行要加上 `--no-daemon`, 且同时不能 watch, 所以在开发的时候还是用更轻量的 nodemon 吧
